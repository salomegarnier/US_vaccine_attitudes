---
title: "Modeling"
author: "Salom√© Garnier, Simone Lewis, Neha Gupta, Corbin Duncan, Connor Brown"
date: "4/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load packages
library(tidyverse)
library(pROC)
library(glmnet)
library(readr)

#load dataset
demographics <- read_csv("demographics.csv")
```

Hey guys! With the code above, you should be able to read and use the demographics dataset for modeling. You can also find it in the Data folder, with the vaccine_data dataset which contains all of the columns that we won't really use. Let me know if you need to add an additional variable to the demographics dataset!

```{r dummyvars}
#dummy variables

#gender

demographics$female <- as.numeric(demographics$gender == "Female")

#age
demographics$age18_24 <- as.numeric(demographics$age_group == 1)
demographics$age25_44 <- as.numeric(demographics$age_group == 2)
demographics$age45_60 <- as.numeric(demographics$age_group == 3)
demographics$age61_70 <- as.numeric(demographics$age_group == 4)
demographics$over70 <- as.numeric(demographics$age_group == 5)

#education
demographics$ms_orless <- as.numeric(demographics$education == 1)
demographics$hs_grad <- as.numeric(demographics$education == 2)
demographics$undergrad <- as.numeric(demographics$education == 3)
demographics$graduate <- as.numeric(demographics$education == 3)
demographics$masters_or_more <- as.numeric(demographics$education == 5|demographics$education == 6| demographics$education == 7)

#race
demographics$asian <- as.numeric(demographics$race == "Asian")
demographics$black <- as.numeric(demographics$race == "Black")
demographics$hispanic <- as.numeric(demographics$race == "Hispanic")
demographics$other <- as.numeric(demographics$race == "Other")
demographics$white <- as.numeric(demographics$race == "White")

#financial status
demographics$lower_middle <- as.numeric(demographics$financial_status == 1)
demographics$middle_class <- as.numeric(demographics$financial_status == 2)
demographics$upper_middle_class <- as.numeric(demographics$financial_status == 3)
demographics$wealthy <- as.numeric(demographics$financial_status == 4)

```

Connor: I went back into the .csv and added an id column (I'll upload to Git) which allowed me to split using random sampling between training and testing data. 

```{r test and train}
#split demographics voter data into training and test set using sampling
#Set seed for replication
set.seed(02138)

#allocated 75% of data to training
n_train  <- floor(nrow(demographics) * 0.75)

#allocated 25% of data to testing
n_test   <- nrow(demographics) - n_train 
demographics_split <- sample(c(rep(TRUE, n_train), rep(FALSE, n_test)))

#label according to id column
train_id <- demographics[demographics_split == TRUE, "id"]
test_id  <- demographics[demographics_split == FALSE,"id"]

```
Connor: Here I fitted a logistic regression model on the predictor (X) demographic variables of gender, age, education, race, and financial status. Intention to take up the covid vaccine based on the survey results is the outcome variable (Y). From looking at the model output, education level and financial status are significant at the p < 0.05 level; there is a positive relationship. Age is also slightly significant at the 0.10 level, again there is a positive relationship. 

```{r fit model}
## USA Model
#fit the demographic variables onto the outcome variable of vaccine acceptance
fm1 <- covid_vaccine ~ gender + age_group + education + race + financial_status 

#estimate model (logistic regression)
model1 <- glm(fm1, data = demographics, subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model1)

## East North Central Model
model2 <- glm(fm1, data = demographics[demographics$Census_region == "East North Central",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model2)

## East South Central
model3 <- glm(fm1, data = demographics[demographics$Census_region == "East South Central",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model3)

## Mid-Atlantic
model4 <- glm(fm1, data = demographics[demographics$Census_region == "Mid-Atlantic",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model4)

## Mountain
model5 <- glm(fm1, data = demographics[demographics$Census_region == "Mountain",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model5)

## Pacific 
model6 <- glm(fm1, data = demographics[demographics$Census_region == "Pacific",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model6)

## New England
model7 <- glm(fm1, data = demographics[demographics$Census_region == "New England",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model7)

## South Atlantic 
model8 <- glm(fm1, data = demographics[demographics$Census_region == "South Atlantic",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model8)

## West North Central 
model9 <- glm(fm1, data = demographics[demographics$Census_region == "West North Central",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model9)

## West South Central
model10 <- glm(fm1, data = demographics[demographics$Census_region == "West South Central",], subset = id %in% train_id,
             family = "binomial", na.action = na.exclude)
summary(model10)

table(demographics$Census_region)

```

```{r prediction outcomes}
#Create yhat variable based on the country level model
demographics$yhat <- predict(model1, newdata = demographics, "response")

#Plot histogram of predicted value density
hist(demographics$yhat, freq = FALSE, xlim = c(0, 1), ylim = c(0, 6))

```

```{r roc curve}
#Compute ROC curve 
nc.roc1 <- roc(
  response  = demographics$covid_vaccine[nc$id %in% test_id],
  predictor = demographics$yhat[nc$id %in% test_id]
)

#Plot ROC curve
plot(nc.roc1, 
     xlab = "False Positive Rate or 1-Specificity",
     ylab = "True Positive Rate or Sensitivity",
     main = "ROC Curve (Our Model)",
     legacy.axes = TRUE)
```